{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mock Test</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <style>
    :root {
      --bg: #f7f8fa;
      --panel: #ffffff;
      --border: #d9dce3;
      --text: #1c1f26;
      --muted: #6b7280;
      --accent: #2563eb;
      --danger: #dc2626;
      --pill-answered: #e0f2fe;
      --pill-answered-border: #bfdbfe;
      --pill-review: #fef3c7;
      --pill-review-border: #fcd34d;
      --option-bg: #ffffff;
      --option-bg-hover: #e0f2fe;
    }
    body { background: linear-gradient(135deg, #eef2f7 0%, #f7f8fa 40%, #ffffff 100%); color: var(--text); min-height:100vh; }
    .shadow-soft { box-shadow:0 4px 18px rgba(0,0,0,0.06); }
    .topbar { background:#0f172a; color:#fff; }
    .topbar .brand { font-weight:700; letter-spacing:0.2px; }
    .topbar .timer { font-size:1.25rem; font-weight:700; }
    .side-panel { background:#0b1220; color:#e2e8f0; border-radius:14px; }
    .side-panel .card-body { max-height:calc(100vh - 140px); overflow:auto; }
    .tab-chip { padding:8px 10px; border-radius:10px; background:#111828; color:#e2e8f0; border:1px solid #1f2937; cursor:pointer; font-weight:600; }
    .tab-chip.active { background:#2563eb; border-color:#2563eb; color:#fff; }
    .question-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(44px, 1fr)); gap:8px; padding:8px 4px; }
    .q-pill { padding:10px 0; border:1px solid #1f2937; border-radius:10px; text-align:center; font-weight:700; background:#0f172a; color:#e2e8f0; cursor:pointer; }
    .q-pill.answered { background:var(--pill-answered); border-color:var(--pill-answered-border); color:#0f172a; }
    .q-pill.review { background:var(--pill-review); border-color:var(--pill-review-border); color:#0f172a; }
    .q-pill.current { border:2px solid var(--accent); box-shadow:0 0 0 2px rgba(37,99,235,0.15); }
    .legend-dot { width:12px; height:12px; border-radius:50%; display:inline-block; }
    .option { border:1px solid var(--border); border-radius:10px; padding:12px 14px; background:var(--option-bg); cursor:pointer; transition: background-color 0.15s ease, border-color 0.15s ease; }
    .option:hover { background:var(--option-bg-hover); }
    .option.selected { border-color: var(--accent); background:var(--pill-answered); box-shadow:0 0 0 2px rgba(37,99,235,0.15); }
    .sticky-top-lite { position:sticky; top:0; z-index:1020; }
    .bottom-bar { position:sticky; bottom:0; z-index:1010; background:#fff; border-top:1px solid var(--border); }
    @media (max-width: 992px) {
      #sidebar { display:none; }
      .topbar { padding:10px 14px; }
    }
  </style>
</head>
<body data-mocktest="{{ mocktest_id }}" class="bg-light">
  <header class="topbar sticky-top-lite py-2 px-3 d-flex align-items-center justify-content-between shadow-soft">
    <div>
      <div id="exam-title" class="brand">Mock Test</div>
      <div class="text-light small opacity-75" id="exam-meta"></div>
    </div>
    <div class="timer" id="timer">--:--:--</div>
  </header>

  <div class="container-fluid py-3">
    <div class="row g-3 flex-lg-row flex-column-reverse">
      <div class="col-lg-9 col-12">
        <div class="card shadow-soft mb-3">
          <div class="card-body">
            <div class="text-muted small mb-2" id="q-path"></div>
            <div class="fs-6 mb-3" id="question-stem"></div>
            <div class="d-grid gap-2" id="options"></div>
          </div>
        </div>

        <div class="card shadow-soft mb-3">
          <div class="card-body d-flex flex-wrap gap-2">
            <button class="btn btn-outline-secondary btn-sm" id="mark-review">Mark for Review</button>
            <button class="btn btn-outline-secondary btn-sm" id="clear-answer">Clear</button>
            <button class="btn btn-outline-secondary btn-sm" id="prev">Previous</button>
            <button class="btn btn-primary btn-sm" id="next">Save & Next</button>
            <button class="btn btn-danger btn-sm ms-auto" id="submit">Submit</button>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-md-6">
            <div class="card shadow-soft h-100">
              <div class="card-body">
                <div class="text-muted small mb-2">Notepad</div>
                <textarea id="notepad" class="form-control" rows="6" placeholder="Notes..." aria-label="Notepad"></textarea>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card shadow-soft h-100">
              <div class="card-body">
                <div class="text-muted small mb-2">Scratchpad (placeholder)</div>
                <div id="scratch" class="border rounded" style="height:220px; background:#f8f9fa;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-3 col-12">
        <div class="card side-panel shadow-soft" id="sidebar">
          <div class="card-body">
            <div class="d-flex flex-wrap gap-2 mb-3" id="tab-list"></div>
            <div class="question-grid" id="question-list"></div>
            <div class="d-flex flex-wrap gap-3 mt-3">
              <div class="d-flex align-items-center gap-2 text-light small"><span class="legend-dot" style="background:var(--pill-answered); border:1px solid var(--pill-answered-border);"></span>Answered</div>
              <div class="d-flex align-items-center gap-2 text-light small"><span class="legend-dot" style="background:var(--pill-review); border:1px solid var(--pill-review-border);"></span>Review</div>
              <div class="d-flex align-items-center gap-2 text-light small"><span class="legend-dot" style="border:2px solid var(--accent);"></span>Current</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    const mocktestId = Number(document.body.dataset.mocktest);
    const apiUrl = `/mocktest/api/mocktests/${mocktestId}/config/resolved/`;

    const state = {
      tabs: [],
      currentTabIdx: 0,
      currentQIdx: 0,
      answers: {}, // key: tab_idx|q_idx -> {value, review}
      timeLimitSeconds: null,
      remaining: null,
      timerHandle: null,
    };

    function fmtTimer(sec) {
      if (sec == null) return '--:--:--';
      const h = String(Math.floor(sec / 3600)).padStart(2,'0');
      const m = String(Math.floor((sec % 3600)/60)).padStart(2,'0');
      const s = String(sec % 60).padStart(2,'0');
      return `${h}:${m}:${s}`;
    }

    function startTimer(totalSeconds) {
      state.remaining = totalSeconds;
      const el = document.getElementById('timer');
      if (state.timerHandle) clearInterval(state.timerHandle);
      state.timerHandle = setInterval(() => {
        if (state.remaining <= 0) {
          clearInterval(state.timerHandle);
          el.textContent = '00:00:00';
          alert('Time is up. Submitting...');
          submitTest();
          return;
        }
        state.remaining -= 1;
        el.textContent = fmtTimer(state.remaining);
      }, 1000);
      el.textContent = fmtTimer(state.remaining);
    }

    function renderTabs() {
      const wrap = document.getElementById('tab-list');
      wrap.innerHTML = '';
      state.tabs.forEach((t, idx) => {
        const chip = document.createElement('div');
        chip.className = 'tab-chip' + (idx === state.currentTabIdx ? ' active' : '');
        chip.textContent = t.tab_name || `Tab ${idx+1}`;
        chip.addEventListener('click', () => { state.currentTabIdx = idx; state.currentQIdx = 0; renderAll(); });
        wrap.appendChild(chip);
      });
    }

    function renderQuestionList() {
      const list = document.getElementById('question-list');
      list.innerHTML = '';
      const tab = state.tabs[state.currentTabIdx];
      tab.mcq_records.forEach((q, idx) => {
        const pill = document.createElement('li');
        pill.className = 'q-pill';
        pill.textContent = idx + 1;
        const key = `${state.currentTabIdx}|${idx}`;
        const ans = state.answers[key];
        if (ans?.value != null) pill.classList.add('answered');
        if (ans?.review) pill.classList.add('review');
        if (idx === state.currentQIdx) pill.classList.add('current');
        pill.addEventListener('click', () => { state.currentQIdx = idx; renderAll(); });
        list.appendChild(pill);
      });
    }

    function renderQuestion() {
      const tab = state.tabs[state.currentTabIdx];
      const q = tab.mcq_records[state.currentQIdx];
      document.getElementById('q-path').textContent = `${tab.tab_name} • Q${state.currentQIdx + 1}`;
      document.getElementById('question-stem').innerHTML = q.question || '(no question)';

      const opts = document.getElementById('options');
      opts.innerHTML = '';
      const key = `${state.currentTabIdx}|${state.currentQIdx}`;
      const saved = state.answers[key]?.value;
      const optionList = q.options && q.options.length ? q.options : [];
      optionList.forEach((opt, idx) => {
        const row = document.createElement('div');
        row.className = 'option' + (saved === idx ? ' selected' : '');
        row.innerHTML = `<strong>${String.fromCharCode(65+idx)}.</strong> <span>${opt}</span>`;
        row.addEventListener('click', () => {
          state.answers[key] = { value: idx, review: state.answers[key]?.review || false };
          renderQuestionList();
          renderQuestion();
        });
        opts.appendChild(row);
      });
    }

    function bindControls() {
      document.getElementById('next').onclick = () => {
        const tab = state.tabs[state.currentTabIdx];
        if (state.currentQIdx < tab.mcq_records.length - 1) {
          state.currentQIdx += 1;
        } else if (state.currentTabIdx < state.tabs.length -1) {
          state.currentTabIdx += 1; state.currentQIdx = 0;
        }
        renderAll();
      };
      document.getElementById('prev').onclick = () => {
        if (state.currentQIdx > 0) {
          state.currentQIdx -= 1;
        } else if (state.currentTabIdx > 0) {
          state.currentTabIdx -= 1;
          const tab = state.tabs[state.currentTabIdx];
          state.currentQIdx = Math.max(0, tab.mcq_records.length -1);
        }
        renderAll();
      };
      document.getElementById('clear-answer').onclick = () => {
        const key = `${state.currentTabIdx}|${state.currentQIdx}`;
        if (state.answers[key]) state.answers[key].value = null;
        renderQuestionList();
        renderQuestion();
      };
      document.getElementById('mark-review').onclick = () => {
        const key = `${state.currentTabIdx}|${state.currentQIdx}`;
        const existing = state.answers[key] || {};
        state.answers[key] = { ...existing, review: !existing.review };
        renderQuestionList();
      };
      document.getElementById('submit').onclick = () => {
        const ok = confirm('Submit test?');
        if (ok) submitTest();
      };
    }

    function submitTest() {
      const answered = Object.values(state.answers).filter(a => a?.value != null).length;
      alert(`Submitting... answered ${answered}`);
    }

    function renderAll() {
      renderTabs();
      renderQuestionList();
      renderQuestion();
    }

    async function bootstrap() {
      const res = await fetch(apiUrl);
      const data = await res.json();
      const tabs = data.tabs || [];
      // normalize mcq_records fallback
      tabs.forEach(t => { t.mcq_records = t.mcq_records || []; });
      state.tabs = tabs;
      document.getElementById('exam-title').textContent = data.mocktest?.title || 'Mock Test';
      document.getElementById('exam-meta').textContent = `${data.mocktest?.exam || ''} • ${data.mocktest?.mock_type || ''}`;
      const maxTime = Math.max(...tabs.map(t => t.time_limit_minutes || 0));
      if (maxTime > 0) startTimer(maxTime * 60);
      bindControls();
      renderAll();
    }

    bootstrap().catch(err => {
      console.error(err);
      alert('Failed to load mock test');
    });
  </script>
</body>
</html>
