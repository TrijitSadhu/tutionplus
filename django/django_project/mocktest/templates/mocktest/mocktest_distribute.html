{% extends "admin/base_site.html" %}
{% load static %}
{% block content %}
<h1>Distribute Questions: {{ mocktest.title }}</h1>
<p>Use filters to add distribution rules per tab. "Auto" will immediately pick random MCQs matching the filters and add them to the tab.</p>
<form style="display:none;">{% csrf_token %}</form>
<button type="button" class="button regen-mock" style="margin:8px 0;">Regenerate Mock</button>
<hr>
{% for t in tabs %}
  <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
    <h3 style="margin:0;">Tab: {{ t.tab.name }} ({{ t.selection_mode }})</h3>
    {% if t.selection_mode == "auto" %}
    <button type="button" class="button regen-tab" data-tab-id="{{ t.id }}">Regenerate Tab</button>
    {% endif %}
  </div>
  <p>Current total questions: {{ t.current_questions }} / {{ t.total_questions }}</p>
  <table class="table" style="margin-bottom:12px;">
    <thead>
      <tr>
        <th>ID</th>
        <th>Model</th>
        <th>Subject</th>
        <th>Chapter</th>
        <th>Sub Chapter</th>
        <th>Section</th>
        <th>Difficulty</th>
        <th>Question Type</th>
        <th>Count</th>
        <th>MCQ IDs</th>
        <th>MCQ List</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for r in t.distribution_rules.all %}
      <tr>
        <td>{{ r.id }}</td>
        <td>{{ r.mcq_model }}</td>
        <td>{{ r.subject }}</td>
        <td>{{ r.chapter }}</td>
        <td>{{ r.sub_chapter }}</td>
        <td>{{ r.section }}</td>
        <td>{{ r.difficulty }}</td>
        <td>{{ r.question_type }}</td>
        <td>{% if r.selected_mcq_ids %}{{ r.selected_mcq_ids|length }}{% else %}{{ r.question_count }}{% endif %}</td>
        <td>{{ r.selected_mcq_ids|join:", " }}</td>
        <td>{{ r.mcq_list }}</td>
        <td><button type="button" class="button restore-rule" data-rule-id="{{ r.id }}">Restore</button></td>
      </tr>
      {% empty %}
      <tr><td colspan="12">No rules yet.</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="rule-box" data-tab-id="{{ t.id }}" style="margin-bottom:16px; padding:10px; border:1px solid #ddd;">
    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:flex-end;">
      <label>Model
        <select class="model" style="min-width:150px;"></select>
      </label>
      <label>Subject
        <select class="subject" style="min-width:130px;"></select>
      </label>
      <label>Chapter
        <select class="chapter" style="min-width:130px;"></select>
      </label>
      <label>Sub Chapter
        <select class="sub_chapter" style="min-width:130px;"></select>
      </label>
      <label>Section
        <select class="section" style="min-width:130px;"></select>
      </label>
      <label>Difficulty
        <select class="difficulty" style="min-width:120px;">
          <option value="">Any</option>
          <option value="easy">easy</option>
          <option value="medium">medium</option>
          <option value="hard">hard</option>
        </select>
      </label>
      <label>Question Type
        <input type="text" class="question_type" style="width:120px;" placeholder="Optional">
      </label>
      <label>Count
        <input type="number" class="question_count" style="width:80px;" min="1" value="1">
      </label>
      <label>Auto
        <input type="checkbox" class="auto" checked>
      </label>
      <button type="button" class="button add-rule">Add Rule</button>
    </div>
  </div>
  <hr>
{% endfor %}

<script>
(function() {
  const urls = {
    models: '{% url "admin:mocktest_ajax_models" %}',
    subjects: '{% url "admin:mocktest_ajax_subjects" %}',
    chapters: '{% url "admin:mocktest_ajax_chapters" %}',
    subChapters: '{% url "admin:mocktest_ajax_sub_chapters" %}',
    sections: '{% url "admin:mocktest_ajax_sections" %}',
    addRule: '{% url "admin:mocktest_ajax_add_rule" %}',
    deleteRule: '{% url "admin:mocktest_ajax_delete_rule" %}',
    regenerateMock: '{% url "admin:mocktest_ajax_regenerate_mock" %}',
    regenerateTab: '{% url "admin:mocktest_ajax_regenerate_tab" %}',
  };

  function setOptions(select, values, emptyLabel='Any') {
    select.innerHTML = `<option value="">${emptyLabel}</option>`;
    (values || []).forEach(v => {
      const opt = document.createElement('option');
      if (typeof v === 'object') {
        opt.value = v.value ?? v;
        opt.textContent = v.label ?? v.value ?? v;
      } else {
        opt.value = v;
        opt.textContent = v;
      }
      select.appendChild(opt);
    });
  }

  function loadModels(box) {
    fetch(urls.models).then(r => r.json()).then(data => {
      setOptions(box.querySelector('.model'), (data.results || []).map(m => ({label: m, value: m})), 'Select Model');
      setOptions(box.querySelector('.subject'), []);
      setOptions(box.querySelector('.chapter'), []);
      setOptions(box.querySelector('.sub_chapter'), []);
      setOptions(box.querySelector('.section'), []);
    });
  }

  function loadChapters(box) {
    const model = box.querySelector('.model').value;
    if (!model) return;
    fetch(urls.chapters + '?' + new URLSearchParams({model}))
      .then(r => r.json()).then(data => {
        setOptions(box.querySelector('.chapter'), data.results || []);
        setOptions(box.querySelector('.sub_chapter'), []);
        setOptions(box.querySelector('.section'), []);
      });
  }

  function loadSubjects(box) {
    const model = box.querySelector('.model').value;
    const chapter = box.querySelector('.chapter').value;
    if (!model) return;
    fetch(urls.subjects + '?' + new URLSearchParams({model, chapter}))
      .then(r => r.json()).then(data => {
        setOptions(box.querySelector('.subject'), data.results || []);
        setOptions(box.querySelector('.sub_chapter'), []);
        setOptions(box.querySelector('.section'), []);
      });
  }

  function loadSubChapters(box) {
    const model = box.querySelector('.model').value;
    const subject = box.querySelector('.subject').value;
    const chapter = box.querySelector('.chapter').value;
    if (!model) return;
    fetch(urls.subChapters + '?' + new URLSearchParams({model, subject, chapter}))
      .then(r => r.json()).then(data => {
        setOptions(box.querySelector('.sub_chapter'), data.results || []);
        setOptions(box.querySelector('.section'), []);
      });
  }

  function loadSections(box) {
    const model = box.querySelector('.model').value;
    const subject = box.querySelector('.subject').value;
    const chapter = box.querySelector('.chapter').value;
    const sub_chapter = box.querySelector('.sub_chapter').value;
    if (!model) return;
    fetch(urls.sections + '?' + new URLSearchParams({model, subject, chapter, sub_chapter}))
      .then(r => r.json()).then(data => {
        setOptions(box.querySelector('.section'), data.results || []);
      });
  }

  document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
    document.querySelectorAll('.rule-box').forEach(box => {
      loadModels(box);
      box.querySelector('.model').addEventListener('change', () => {
        if (!box.querySelector('.model').value) {
          setOptions(box.querySelector('.subject'), []);
          setOptions(box.querySelector('.chapter'), []);
          setOptions(box.querySelector('.sub_chapter'), []);
          setOptions(box.querySelector('.section'), []);
          return;
        }
        loadChapters(box);
        loadSubjects(box);
      });
      box.querySelector('.chapter').addEventListener('change', () => {
        loadSubjects(box);
        loadSubChapters(box);
      });
      box.querySelector('.subject').addEventListener('change', () => loadSubChapters(box));
      box.querySelector('.sub_chapter').addEventListener('change', () => loadSections(box));

      box.querySelector('.add-rule').addEventListener('click', () => {
        const model = box.querySelector('.model').value;
        const tabId = box.dataset.tabId;
        if (!model) { alert('Select a model first'); return; }
        const payload = {
          tab_id: tabId,
          model,
          subject: box.querySelector('.subject').value,
          chapter: box.querySelector('.chapter').value,
          sub_chapter: box.querySelector('.sub_chapter').value,
          section: box.querySelector('.section').value,
          difficulty: box.querySelector('.difficulty').value,
          question_type: box.querySelector('.question_type').value,
          question_count: box.querySelector('.question_count').value || 1,
          auto: box.querySelector('.auto').checked,
        };
        fetch(urls.addRule, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
			'X-CSRFToken': csrfToken
          },
          body: new URLSearchParams(payload)
        }).then(r => r.json()).then(data => {
          if (data.error) { alert(data.error); return; }
          if (data.requested !== undefined && data.added !== undefined) {
            alert(`Added ${data.added} of ${data.requested}`);
          }
          window.location.reload();
        });
      });
    });

    document.querySelectorAll('.restore-rule').forEach(btn => {
      btn.addEventListener('click', () => {
        const ruleId = btn.dataset.ruleId;
        if (!ruleId) return;
        if (!confirm('Restore: remove this rule and its auto-added questions?')) return;
        fetch(urls.deleteRule, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken
          },
          body: new URLSearchParams({rule_id: ruleId})
        }).then(r => r.json()).then(data => {
          if (data.error) { alert(data.error); return; }
          window.location.reload();
        });
      });
    });

    document.querySelectorAll('.regen-tab').forEach(btn => {
      btn.addEventListener('click', () => {
        const tabId = btn.dataset.tabId;
        if (!tabId) return;
        if (!confirm('Regenerate this tab? This will re-pick auto questions for this tab based on its rules.')) return;
        fetch(urls.regenerateTab, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken
          },
          body: new URLSearchParams({tab_id: tabId})
        }).then(r => r.json()).then(data => {
          if (data.error) { alert(data.error); return; }
          window.location.reload();
        });
      });
    });

    const regenMockBtn = document.querySelector('.regen-mock');
    if (regenMockBtn) {
      regenMockBtn.addEventListener('click', () => {
        if (!confirm('Regenerate this mock? This will re-pick auto questions for all tabs based on current rules.')) return;
        fetch(urls.regenerateMock, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken
          },
          body: new URLSearchParams({mock_id: '{{ mocktest.id }}'})
        }).then(r => r.json()).then(data => {
          if (data.error) { alert(data.error); return; }
          window.location.reload();
        });
      });
    }
  });
})();
</script>
{% endblock %}
