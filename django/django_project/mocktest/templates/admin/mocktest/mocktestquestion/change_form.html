{% extends "admin/change_form.html" %}
{% load i18n static %}
{% block after_related_objects %}
<div id="mcq-picker" style="margin-top:16px; padding:12px; border:1px solid #ddd; background:#fafafa;">
  <h3 style="margin-top:0;">Pick MCQ with filters</h3>
  <div class="mcq-filters" style="display:flex; gap:8px; flex-wrap:wrap; align-items:flex-end;">
    <label>Model
      <select class="mcq-model" style="min-width:160px;"></select>
    </label>
    <label>Subject
      <select class="mcq-subject" style="min-width:140px;"></select>
    </label>
    <label>Chapter
      <select class="mcq-chapter" style="min-width:140px;"></select>
    </label>
    <label>Sub Chapter
      <select class="mcq-sub-chapter" style="min-width:140px;"></select>
    </label>
    <label>Section
      <select class="mcq-section" style="min-width:140px;"></select>
    </label>
    <label>Question Type
      <input type="text" class="mcq-question-type" style="width:140px;" placeholder="Optional" />
    </label>
    <label>Difficulty
      <input type="text" class="mcq-difficulty" style="width:120px;" placeholder="Optional" />
    </label>
    <button type="button" class="button mcq-search">Search</button>
  </div>
  <div class="mcq-results" style="margin-top:10px; max-height:300px; overflow:auto;">
    <table class="table" style="width:100%;">
      <thead>
        <tr>
          <th>MCQ ID</th>
          <th>Question</th>
          <th>Subject</th>
          <th>Chapter</th>
          <th>Sub Chapter</th>
          <th>Section</th>
          <th>Difficulty</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="8">Use filters and click Search.</td></tr>
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block extrahead %}{{ block.super }}
<script>
(function() {
  const urls = {
    models: '{% url "admin:mocktest_ajax_models" %}',
    subjects: '{% url "admin:mocktest_ajax_subjects" %}',
    chapters: '{% url "admin:mocktest_ajax_chapters" %}',
    subChapters: '{% url "admin:mocktest_ajax_sub_chapters" %}',
    sections: '{% url "admin:mocktest_ajax_sections" %}',
    search: '{% url "admin:mocktest_ajax_search_mcqs" %}',
  };

  function setOptions(select, values, emptyLabel='Any') {
    select.innerHTML = `<option value="">${emptyLabel}</option>`;
    (values || []).forEach(v => {
      const opt = document.createElement('option');
      if (typeof v === 'object') {
        opt.value = v.value ?? v;
        opt.textContent = v.label ?? v.value ?? v;
      } else {
        opt.value = v;
        opt.textContent = v;
      }
      select.appendChild(opt);
    });
  }

  function loadModels(box) {
    fetch(urls.models).then(r => r.json()).then(data => {
      const models = (data.results || []).map(m => ({label: m, value: m}));
      setOptions(box.querySelector('.mcq-model'), models, 'Select Model');
      setOptions(box.querySelector('.mcq-subject'), []);
      setOptions(box.querySelector('.mcq-chapter'), []);
      setOptions(box.querySelector('.mcq-sub-chapter'), []);
      setOptions(box.querySelector('.mcq-section'), []);
    });
  }

  function loadChapters(box) {
    const model = box.querySelector('.mcq-model').value;
    if (!model) return;
    fetch(urls.chapters + '?' + new URLSearchParams({model}))
      .then(r => r.json())
      .then(data => {
        setOptions(box.querySelector('.mcq-chapter'), data.results || []);
        setOptions(box.querySelector('.mcq-sub-chapter'), []);
        setOptions(box.querySelector('.mcq-section'), []);
      });
  }

  function loadSubjects(box) {
    const model = box.querySelector('.mcq-model').value;
    const chapter = box.querySelector('.mcq-chapter').value;
    if (!model) return;
    fetch(urls.subjects + '?' + new URLSearchParams({model, chapter}))
      .then(r => r.json())
      .then(data => {
        setOptions(box.querySelector('.mcq-subject'), data.results || []);
        setOptions(box.querySelector('.mcq-sub-chapter'), []);
        setOptions(box.querySelector('.mcq-section'), []);
      });
  }

  function loadSubChapters(box) {
    const model = box.querySelector('.mcq-model').value;
    const subject = box.querySelector('.mcq-subject').value;
    const chapter = box.querySelector('.mcq-chapter').value;
    if (!model) return;
    fetch(urls.subChapters + '?' + new URLSearchParams({model, subject, chapter}))
      .then(r => r.json())
      .then(data => {
        setOptions(box.querySelector('.mcq-sub-chapter'), data.results || []);
        setOptions(box.querySelector('.mcq-section'), []);
      });
  }

  function loadSections(box) {
    const model = box.querySelector('.mcq-model').value;
    const subject = box.querySelector('.mcq-subject').value;
    const chapter = box.querySelector('.mcq-chapter').value;
    const sub_chapter = box.querySelector('.mcq-sub-chapter').value;
    if (!model) return;
    fetch(urls.sections + '?' + new URLSearchParams({model, subject, chapter, sub_chapter}))
      .then(r => r.json())
      .then(data => {
        setOptions(box.querySelector('.mcq-section'), data.results || []);
      });
  }

  function renderResults(box, results) {
    const tbody = box.querySelector('.mcq-results tbody');
    tbody.innerHTML = '';
    if (!results.length) {
      const row = document.createElement('tr');
      row.innerHTML = '<td colspan="8">No results.</td>';
      tbody.appendChild(row);
      return;
    }
    results.forEach(item => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${item.id}</td>
        <td>${item.question || ''}</td>
        <td>${item.subject || ''}</td>
        <td>${item.chapter || ''}</td>
        <td>${item.sub_chapter || ''}</td>
        <td>${item.section || ''}</td>
        <td>${item.difficulty || ''}</td>
        <td><button type="button" class="button add-mcq" data-id="${item.id}" data-model="${item.source}">Use</button></td>
      `;
      tbody.appendChild(row);
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    const box = document.getElementById('mcq-picker');
    if (!box) return;
    const modelSel = box.querySelector('.mcq-model');
    loadModels(box);

    modelSel.addEventListener('change', () => {
      if (!modelSel.value) {
        setOptions(box.querySelector('.mcq-subject'), []);
        setOptions(box.querySelector('.mcq-chapter'), []);
        setOptions(box.querySelector('.mcq-sub-chapter'), []);
        setOptions(box.querySelector('.mcq-section'), []);
        return;
      }
      loadChapters(box);
      loadSubjects(box);
    });
    box.querySelector('.mcq-chapter').addEventListener('change', () => {
      loadSubjects(box);
      loadSubChapters(box);
    });
    box.querySelector('.mcq-subject').addEventListener('change', () => loadSubChapters(box));
    box.querySelector('.mcq-sub-chapter').addEventListener('change', () => loadSections(box));

    box.querySelector('.mcq-search').addEventListener('click', () => {
      const model = modelSel.value;
      if (!model) { alert('Select a model first'); return; }
      const params = {
        model,
        subject: box.querySelector('.mcq-subject').value,
        chapter: box.querySelector('.mcq-chapter').value,
        sub_chapter: box.querySelector('.mcq-sub-chapter').value,
        section: box.querySelector('.mcq-section').value,
        question_type: box.querySelector('.mcq-question-type').value,
        difficulty: box.querySelector('.mcq-difficulty').value,
      };
      fetch(urls.search + '?' + new URLSearchParams(params))
        .then(r => r.json())
        .then(data => {
          if (data.error) { alert(data.error); return; }
          renderResults(box, data.results || []);
        });
    });

    box.querySelector('.mcq-results tbody').addEventListener('click', ev => {
      if (!ev.target.classList.contains('add-mcq')) return;
      const mcqId = ev.target.dataset.id;
      const mcqModel = ev.target.dataset.model;
      const idField = document.getElementById('id_mcq_id');
      const modelField = document.getElementById('id_mcq_model');
      if (idField) idField.value = mcqId;
      if (modelField) modelField.value = mcqModel;
    });
  });
})();
</script>
{% endblock %}
